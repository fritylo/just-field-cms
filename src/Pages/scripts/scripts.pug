<?php require_once $php . '/JustField.php'; ?>
<?php $db = new JustField\DB($orm, ['assets' => $assets]); ?>
<?php global $unset_session_prop; ?>

- echo('1,');

<?php function gen_from_get($prefix) { ?>
<?php    return function (&$variable, $get_key, $is_echo = true) use ($prefix) { ?>
<?php       if (isset($_GET[$get_key])) { ?>
<?php          $variable = $_GET[$get_key]; ?>
<?php       } else if ($is_echo) { ?>
<?php          echo($prefix . ': ' . "no \"$get_key\" in \$_GET" . '<br>'); ?>
<?php       } else { ?>
<?php          $variable = null; ?>
<?php       } ?>
<?php    }; ?>
<?php } ?>

- echo('2,');

<?php function gen_from_post($prefix) { ?>
<?php    return function (&$variable, $get_key, $is_echo = true) use ($prefix) { ?>
<?php       if (isset($_POST[$get_key])) { ?>
<?php          $variable = $_POST[$get_key]; ?>
<?php       } else if ($is_echo) { ?>
<?php          echo($prefix . ': ' . "no \"$get_key\" in \$_POST" . '<br>'); ?>
<?php       } else { ?>
<?php          $variable = null; ?>
<?php       } ?>
<?php    }; ?>
<?php } ?>

- echo('3,');

if isset($_GET['script'])
   - echo('4,');
   - var script = $_GET['script'];

   if script == 'exit'
      - session_start();
      - unset_session_prop('id');
      - session_destroy();

      - header("Location: ./dev.php?page=login");
      - die;


   else if script == 'login'
      - echo('5,');

      if isset($_POST['login']) && isset($_POST['password'])
         - session_start();
         - echo('6,');

         - var login = $_POST['login'];
         - var password = $_POST['password'];
         - echo('7,');

         - db.orm.is_log = false
         - echo('8,');

         - var id = orm.from('account').select('id_account').where(`account_login = '${login}' AND account_password = '${password}'`)();
         - echo('9,');

         if (!id)
            - echo('a10,');
            - $_SESSION['login_error'] = 'uncorrect login or password';
            - header('Location: ./dev.php?page=login');
         else
            - echo('b10,');
            - var id = id[0]['id_account'];
            - echo('b11,');
            - $_SESSION['id'] = id;
            - echo('b12,');
            - var_dump(unset_session_prop)
            - unset_session_prop('login_error'); // FIXME: BEGET CRUSH HERE
            - echo('b13,');
            - header('Location: ./dev.php?page=main');
            - echo('b14,');
      else
         - echo('NO POST');

   else if script == 'field-add'
      - var from_get = gen_from_get('field-add')

      - from_get(field_type_id, 'type-id')
      - from_get(path, 'path')

      - db.orm.is_log = false
      - var new_field_id = db.at_path(path).add_field(field_type_id)

      - echo(`{ "status": "OK", "id": "${new_field_id}"}`)

   else if script == 'field-update'
      - var from_post = gen_from_post('field-update')

      - from_post(item_id, 'item_id')
      - from_post(colname, 'colname')
      - from_post(value, 'value', false)

      - db.orm.is_log = false
      - var res = db.at_id(item_id).update(colname, value)

      - echo('{ "status": "OK", "data": "'+res+'" }')

   else if script == 'field-delete'
      - var from_get = gen_from_get('field-delete')

      - from_get(item_id, 'item_id')

      - db.orm.is_log = false
      - db.at_id(item_id).remove()

      - echo('{ "status": "OK" }')

   else if script == 'field-duplicate'
      - var from_get = gen_from_get('field-duplicate')
      
      - from_get(item_id, 'item_id')

      - db.orm.is_log = false
      - var new_id = db.at_id(item_id).duplicate()

      - echo('{ "status": "OK", "id": '+new_id+' }')
   else if script == 'info'
      - phpinfo()

else
   | Error: no or unexpected script in $_GET